# å›æµ‹Kçº¿å›¾è¡¨æŸ¥çœ‹å™¨

## åŠŸèƒ½ä»‹ç»

åœ¨vnpy_ctabacktesterå›æµ‹å®Œæˆåï¼Œç‚¹å‡»"Kçº¿å›¾è¡¨"æŒ‰é’®å¯ä»¥å¯åŠ¨ä¸“é—¨çš„å›¾è¡¨æŸ¥çœ‹å™¨æ¥å¯è§†åŒ–å›æµ‹ç»“æœã€‚è¯¥åŠŸèƒ½åŸºäºvnpy_chartwizardï¼Œæä¾›äº†ä¸°å¯Œçš„Kçº¿å›¾è¡¨å’Œäº¤æ˜“æ ‡è®°æ˜¾ç¤ºã€‚

## ä¸»è¦ç‰¹æ€§

### ğŸ“Š å›¾è¡¨åŠŸèƒ½
- **å¤šå‘¨æœŸåˆ‡æ¢**ï¼šæ”¯æŒ1åˆ†é’Ÿã€5åˆ†é’Ÿã€15åˆ†é’Ÿã€30åˆ†é’Ÿã€1å°æ—¶ã€æ—¥çº¿ã€å‘¨çº¿
- **æŠ€æœ¯æŒ‡æ ‡**ï¼šå†…ç½®SMA(5/20/60)ã€MACDç­‰å¸¸ç”¨æŒ‡æ ‡
- **è‡ªå®šä¹‰æ ·å¼**ï¼šé»‘è‰²èƒŒæ™¯ï¼Œçº¢ç»¿Kçº¿ï¼Œä¸“ä¸šå¤–è§‚

### ğŸ’¼ äº¤æ˜“æ ‡è®°
- **è‡ªåŠ¨åŠ è½½**ï¼šä»å›æµ‹ä¿å­˜çš„trades.csvè‡ªåŠ¨åŠ è½½äº¤æ˜“è®°å½•
- **æ™ºèƒ½è¯†åˆ«**ï¼šæ ¹æ®äº¤æ˜“æ–¹å‘æ˜¾ç¤ºä¸åŒé¢œè‰²çš„ç®­å¤´æ ‡è®°
  - ğŸŸ¢ å¤šå¤´ä¹°å…¥ï¼šç»¿è‰²å‘ä¸Šç®­å¤´
  - ğŸ”´ ç©ºå¤´å–å‡ºï¼šçº¢è‰²å‘ä¸‹ç®­å¤´
  - ğŸŸ¡ å…¶ä»–ï¼šé»„è‰²åœ†ç‚¹æ ‡è®°
- **è¯¦ç»†ä¿¡æ¯**ï¼šé¼ æ ‡æ‚¬åœæ˜¾ç¤ºäº¤æ˜“æ–¹å‘ã€ä»·æ ¼ã€æ•°é‡ç­‰ä¿¡æ¯

### ğŸ” æ•°æ®æº
- **Kçº¿æ•°æ®**ï¼šä»vnpyæ•°æ®åº“è‡ªåŠ¨åŠ è½½ï¼Œæ”¯æŒå¢é‡æ›´æ–°
- **äº¤æ˜“æ•°æ®**ï¼šè¯»å–.vntrader/backtestresult/ç›®å½•ä¸‹çš„trades.csv
- **æ—¶é—´èŒƒå›´**ï¼šä½¿ç”¨å›æµ‹è®¾ç½®çš„å¼€å§‹å’Œç»“æŸæ—¥æœŸ

## ä½¿ç”¨æ–¹æ³•

### 1. è¿è¡Œå›æµ‹
1. åœ¨vnpy_ctabacktesterä¸­é…ç½®å›æµ‹å‚æ•°
2. å‹¾é€‰"å•ç‹¬ä¿å­˜"é€‰é¡¹ï¼ˆæ¨èï¼‰
3. ç‚¹å‡»"å¼€å§‹å›æµ‹"è¿è¡Œç­–ç•¥

### 2. æŸ¥çœ‹Kçº¿å›¾è¡¨
1. å›æµ‹å®Œæˆåï¼Œç‚¹å‡»"Kçº¿å›¾è¡¨"æŒ‰é’®
2. ç³»ç»Ÿä¼šè‡ªåŠ¨ï¼š
   - æ£€æµ‹trades.csvæ–‡ä»¶ä½ç½®
   - åŠ è½½å¯¹åº”åˆçº¦çš„Kçº¿æ•°æ®
   - å¯åŠ¨å›¾è¡¨æŸ¥çœ‹å™¨

### 3. å›¾è¡¨æ“ä½œ
- **å‘¨æœŸåˆ‡æ¢**ï¼šä½¿ç”¨é¡¶éƒ¨çš„æ—¶é—´å‘¨æœŸé€‰æ‹©å™¨
- **ç¼©æ”¾å’Œå¹³ç§»**ï¼šé¼ æ ‡æ»šè½®ç¼©æ”¾ï¼Œæ‹–æ‹½å¹³ç§»
- **æŒ‡æ ‡æ˜¾ç¤º**ï¼šè‡ªåŠ¨æ˜¾ç¤ºå¸¸ç”¨æŠ€æœ¯æŒ‡æ ‡
- **äº¤æ˜“æ ‡è®°**ï¼šæŸ¥çœ‹æ¯ä¸ªäº¤æ˜“ç‚¹çš„è¯¦ç»†ä¿¡æ¯

## æ–‡ä»¶ç»“æ„

```
.vntrader/
â”œâ”€â”€ backtestresult/
â”‚   â”œâ”€â”€ [ç­–ç•¥å]_[åˆçº¦]_[æ—¶é—´æˆ³]/
â”‚   â”‚   â”œâ”€â”€ trades.csv          # äº¤æ˜“è®°å½•
â”‚   â”‚   â”œâ”€â”€ strategy_params.json # ç­–ç•¥å‚æ•°
â”‚   â”‚   â””â”€â”€ backtest_chart.png   # å›æµ‹å›¾è¡¨æˆªå›¾
â”‚   â””â”€â”€ trades.csv              # é»˜è®¤ä½ç½®çš„äº¤æ˜“è®°å½•
```

## æŠ€æœ¯å®ç°

### æ ¸å¿ƒæ–‡ä»¶
- `vnpy_chartwizard/backtest_chart_viewer.py` - å›æµ‹å›¾è¡¨æŸ¥çœ‹å™¨ä¸»ç¨‹åº
- `vnpy_ctabacktester/ui/widget.py` - UIé›†æˆå’Œè°ƒç”¨é€»è¾‘

### æ•°æ®æµç¨‹
```
å›æµ‹å®Œæˆ â†’ ä¿å­˜trades.csv â†’ ç‚¹å‡»Kçº¿å›¾è¡¨æŒ‰é’®
    â†“              â†“              â†“
è¯»å–äº¤æ˜“è®°å½• â†’ åŠ è½½Kçº¿æ•°æ® â†’ å¯åŠ¨å›¾è¡¨æŸ¥çœ‹å™¨
    â†“              â†“              â†“
è§£æäº¤æ˜“ä¿¡å· â†’ æ˜¾ç¤ºæŠ€æœ¯æŒ‡æ ‡ â†’ äº¤äº’å¼æŸ¥çœ‹
```

### äº¤æ˜“æ ‡è®°æ ¼å¼
CSVæ–‡ä»¶ä¸­çš„äº¤æ˜“è®°å½•ä¼šè¢«è½¬æ¢ä¸ºå›¾è¡¨æ ‡è®°ï¼š

```csv
dt,direction,price,volume,...
2023-01-01 09:30:00,BUY,4500.0,10,...
```

è½¬æ¢ä¸ºï¼š
```python
{
    'time': '2023-01-01 09:30:00',
    'price': 4500.0,
    'type': 'arrow_up',
    'color': '#00ff00',
    'text': 'BUY 10'
}
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **"æœªæ‰¾åˆ°trades.csvæ–‡ä»¶"**
   - ç¡®ä¿å›æµ‹æ—¶å‹¾é€‰äº†"å•ç‹¬ä¿å­˜"é€‰é¡¹
   - æ£€æŸ¥.vntrader/backtestresult/ç›®å½•æ˜¯å¦å­˜åœ¨

2. **"æœªæ‰¾åˆ°å›¾è¡¨æŸ¥çœ‹å™¨æ¨¡å—"**
   - ç¡®ä¿vnpy_chartwizardå·²æ­£ç¡®å®‰è£…
   - æ£€æŸ¥Pythonè·¯å¾„æ˜¯å¦åŒ…å«vnpy_chartwizard

3. **å›¾è¡¨æ˜¾ç¤ºç©ºç™½**
   - æ£€æŸ¥åˆçº¦ä»£ç æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤æ•°æ®åº“ä¸­æ˜¯å¦æœ‰è¯¥åˆçº¦çš„Kçº¿æ•°æ®
   - æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯ä¿¡æ¯

4. **äº¤æ˜“æ ‡è®°ä¸æ˜¾ç¤º**
   - æ£€æŸ¥trades.csvæ–‡ä»¶çš„æ ¼å¼
   - ç¡®è®¤CSVæ–‡ä»¶åŒ…å«dtã€directionã€priceã€volumeåˆ—
   - æŸ¥çœ‹æ§åˆ¶å°æ˜¯å¦æœ‰è§£æé”™è¯¯ä¿¡æ¯

### æ—¥å¿—è°ƒè¯•
å¯åŠ¨å›¾è¡¨æŸ¥çœ‹å™¨æ—¶ï¼Œä¼šåœ¨æ§åˆ¶å°è¾“å‡ºè¯¦ç»†çš„åŠ è½½ä¿¡æ¯ï¼š
```
å¯åŠ¨å›æµ‹å›¾è¡¨æŸ¥çœ‹å™¨ - åˆçº¦: rb8888, æ—¶é—´: 2022-01-01 è‡³ 2022-12-31
äº¤æ˜“æ–‡ä»¶: C:\Users\...\trades.csv
æˆåŠŸåŠ è½½ 25 æ¡äº¤æ˜“è®°å½•
```

## è‡ªå®šä¹‰é…ç½®

### ä¿®æ”¹é»˜è®¤æŒ‡æ ‡
åœ¨`backtest_chart_viewer.py`ä¸­ä¿®æ”¹æŒ‡æ ‡è®¾ç½®ï¼š

```python
# æ·»åŠ è‡ªå®šä¹‰æŒ‡æ ‡
indicator_manager.add_macd()
indicator_manager.add_boll()
indicator_manager.add_rsi(14)
```

### è°ƒæ•´å›¾è¡¨æ ·å¼
ä¿®æ”¹`chart.layout()`å’Œ`chart.candle_style()`å‚æ•°ï¼š

```python
chart.layout(
    background_color='#001122',  # æ·±è“è‰²èƒŒæ™¯
    text_color='#FFFFFF',
    font_size=14
)
```

### è‡ªå®šä¹‰äº¤æ˜“æ ‡è®°
ä¿®æ”¹`load_sig_from_trades_csv()`å‡½æ•°ä¸­çš„æ ‡è®°é€»è¾‘ï¼š

```python
# è‡ªå®šä¹‰æ ‡è®°ç±»å‹å’Œé¢œè‰²
if 'CLOSE' in direction:
    marker_type = 'diamond'
    color = '#ff00ff'  # å“çº¢
```

## æ€§èƒ½ä¼˜åŒ–

### æ•°æ®åŠ è½½
- å¢é‡åŠ è½½ï¼šåªåŠ è½½å›æµ‹æ—¶é—´èŒƒå›´å†…çš„æ•°æ®
- ç¼“å­˜æœºåˆ¶ï¼šé‡å¤æŸ¥çœ‹æ—¶é¿å…é‡æ–°åŠ è½½
- å¤šè¿›ç¨‹ï¼šå›¾è¡¨æŸ¥çœ‹å™¨åœ¨ç‹¬ç«‹è¿›ç¨‹ä¸­è¿è¡Œ

### å†…å­˜ç®¡ç†
- åˆ†æ‰¹å¤„ç†ï¼šå¤§é‡äº¤æ˜“è®°å½•æ—¶åˆ†æ‰¹åŠ è½½
- åŠæ—¶æ¸…ç†ï¼šä¸å¿…è¦çš„å¯¹è±¡åŠæ—¶é‡Šæ”¾
- é™åˆ¶æ˜¾ç¤ºï¼šé¿å…ä¸€æ¬¡æ€§åŠ è½½è¿‡å¤šæ•°æ®

## æ‰©å±•å¼€å‘

### æ·»åŠ æ–°æŒ‡æ ‡
```python
from lightweight_charts import Indicator

class CustomIndicator(Indicator):
    def __init__(self, chart):
        super().__init__(chart)
        # å®ç°è‡ªå®šä¹‰æŒ‡æ ‡é€»è¾‘
```

### è‡ªå®šä¹‰äº¤æ˜“åˆ†æ
```python
def analyze_trades(trades_df):
    """è‡ªå®šä¹‰äº¤æ˜“åˆ†æé€»è¾‘"""
    # è®¡ç®—èƒœç‡ã€ç›ˆäºæ¯”ç­‰ç»Ÿè®¡ä¿¡æ¯
    win_rate = len(trades_df[trades_df['profit'] > 0]) / len(trades_df)
    return win_rate
```

## æ›´æ–°æ—¥å¿—

### v1.0.0
- âœ¨ å®ç°å›æµ‹ç»“æœKçº¿å›¾è¡¨æŸ¥çœ‹å™¨
- âœ¨ è‡ªåŠ¨åŠ è½½trades.csvä½œä¸ºäº¤æ˜“æ ‡è®°
- âœ¨ æ”¯æŒå¤šå‘¨æœŸåˆ‡æ¢å’Œå¸¸ç”¨æŠ€æœ¯æŒ‡æ ‡
- ğŸ”§ é›†æˆåˆ°vnpy_ctabacktester UIä¸­
- ğŸ“ å®Œå–„æ–‡æ¡£å’Œé”™è¯¯å¤„ç†
