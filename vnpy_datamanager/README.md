# VNpy æ•°æ®ç®¡ç†æµæ°´çº¿

è¿™æ˜¯ä¸€ä¸ªç»Ÿä¸€çš„æ•°æ®ç®¡ç†è§£å†³æ–¹æ¡ˆï¼Œç”¨äºå¤„ç†ä».lc1æ–‡ä»¶åˆ°vnpyæ•°æ®åº“çš„å®Œæ•´æ•°æ®æµç¨‹ã€‚

## åŠŸèƒ½ç‰¹æ€§

- **ç»Ÿä¸€æµæ°´çº¿**ï¼šä».lc1æ–‡ä»¶æ£€æµ‹ã€è½¬æ¢ã€å¯¼å…¥åˆ°èšåˆç”Ÿæˆé«˜å‘¨æœŸæ•°æ®
- **å¢é‡æ›´æ–°**ï¼šæ™ºèƒ½æ£€æµ‹æ–°æ–‡ä»¶å’Œæ•°æ®ï¼Œåªå¤„ç†æ–°å¢å†…å®¹
- **çŠ¶æ€ç®¡ç†**ï¼šè·Ÿè¸ªå¤„ç†è¿›åº¦å’Œæœ€åæ›´æ–°æ—¶é—´
- **é”™è¯¯æ¢å¤**ï¼šæ”¯æŒæ–­ç‚¹ç»­ä¼ å’Œé”™è¯¯é‡è¯•
- **æ€§èƒ½ä¼˜åŒ–**ï¼šé¿å…é‡å¤å¤„ç†ï¼Œæé«˜æ•°æ®åŠ è½½æ•ˆç‡

## æ•°æ®æµç¨‹

```
.lc1æ–‡ä»¶ â†’ æ£€æµ‹æ–°æ–‡ä»¶ â†’ è½¬æ¢ä¸ºCSV â†’ å¯¼å…¥1åˆ†é’Ÿæ•°æ® â†’ èšåˆç”Ÿæˆå°æ—¶çº¿/æ—¥çº¿æ•°æ®
```

## ä¸»è¦ç»„ä»¶

### 1. DataUpdateScheduler (æ•°æ®æ›´æ–°è°ƒåº¦å™¨)
- è·Ÿè¸ªå·²å¤„ç†çš„æ–‡ä»¶å’Œåˆçº¦çŠ¶æ€
- æ£€æµ‹éœ€è¦æ›´æ–°çš„æ•°æ®
- ç®¡ç†å¢é‡æ›´æ–°é€»è¾‘

### 2. æ•°æ®è½¬æ¢ (vnpy_datamanager.engine.download_bar_data_batch)
- å°†.lc1æ–‡ä»¶è½¬æ¢ä¸ºvnpyæ ¼å¼çš„CSVæ–‡ä»¶
- è‡ªåŠ¨è¯†åˆ«åˆçº¦ä»£ç å’Œäº¤æ˜“æ‰€

### 3. æ•°æ®å¯¼å…¥ (ManagerEngine._auto_import_converted_data)
- å°†CSVæ–‡ä»¶å¯¼å…¥åˆ°vnpyæ•°æ®åº“
- æ”¯æŒè¦†ç›–å·²å­˜åœ¨æ•°æ®

### 4. æ•°æ®èšåˆ (vnpy_chartwizard.preprocess_daily_data.BarDataPreprocessor)
- ä»1åˆ†é’Ÿæ•°æ®ç”Ÿæˆå°æ—¶çº¿æ•°æ®
- ä»1åˆ†é’Ÿæ•°æ®ç”Ÿæˆæ—¥çº¿æ•°æ®
- æ”¯æŒå¢é‡èšåˆ

## ä½¿ç”¨æ–¹æ³•

### å‘½ä»¤è¡Œä½¿ç”¨

```bash
# è¿è¡Œå®Œæ•´çš„æ•°æ®æ›´æ–°æµæ°´çº¿
python -m vnpy_datamanager.data_pipeline run

# æŒ‡å®šè‡ªå®šä¹‰è·¯å¾„
python -m vnpy_datamanager.data_pipeline run --source-dir "C:\data\lcd" --target-dir "C:\data\csv"

# åªæ£€æŸ¥å¯ç”¨çš„æ›´æ–°
python -m vnpy_datamanager.data_pipeline check

# æŸ¥çœ‹å½“å‰çŠ¶æ€
python -m vnpy_datamanager.data_pipeline status

# å¼ºåˆ¶æ›´æ–°æ‰€æœ‰æ•°æ®
python -m vnpy_datamanager.data_pipeline run --force-update
```

### Python API ä½¿ç”¨

```python
from vnpy_datamanager.data_pipeline import DataPipelineManager

# åˆ›å»ºæµæ°´çº¿ç®¡ç†å™¨
pipeline = DataPipelineManager()

# è¿è¡Œå®Œæ•´æµæ°´çº¿
result = pipeline.run_pipeline(
    source_dir=r'C:\new_tdxqh\vipdoc\ds\minline',
    target_dir=r'C:\new_tdxqh\vipdoc\ds\minline\csv',
    auto_aggregate=True,
    force_update=False
)

print(f"å¤„ç†ç»“æœ: {result}")

# æ£€æŸ¥æ›´æ–°
updates = pipeline.check_updates()
print(f"å¾…å¤„ç†æ–‡ä»¶: {len(updates['pending_files'])}")
print(f"éœ€è¦æ›´æ–°çš„åˆçº¦: {len(updates['contracts_needing_update'])}")
```

## é…ç½®è¯´æ˜

### é»˜è®¤è·¯å¾„
- **æºç›®å½•**: `C:\new_tdxqh\vipdoc\ds\minline` (.lc1æ–‡ä»¶)
- **ç›®æ ‡ç›®å½•**: `C:\new_tdxqh\vipdoc\ds\minline\csv` (CSVæ–‡ä»¶)
- **æ•°æ®åº“**: `~/.vntrader/database.db`
- **çŠ¶æ€æ–‡ä»¶**: `~/.vntrader/data_update_status.json`

### äº¤æ˜“æ‰€æ˜ å°„
ç³»ç»Ÿå†…ç½®äº†å¸¸è§çš„æœŸè´§åˆçº¦åˆ°äº¤æ˜“æ‰€çš„æ˜ å°„ï¼š

```python
commodity_to_exchange = {
    # ä¸Šæµ·æœŸè´§äº¤æ˜“æ‰€
    'cu': 'SHFE', 'al': 'SHFE', 'zn': 'SHFE', 'rb': 'SHFE', 'ag': 'SHFE',
    # å¤§è¿å•†å“äº¤æ˜“æ‰€
    'm': 'DCE', 'y': 'DCE', 'p': 'DCE', 'l': 'DCE', 'c': 'DCE',
    # éƒ‘å·å•†å“äº¤æ˜“æ‰€
    'CF': 'CZCE', 'SR': 'CZCE', 'TA': 'CZCE', 'OI': 'CZCE',
    # ä¸­å›½é‡‘èæœŸè´§äº¤æ˜“æ‰€
    'IF': 'CFFEX', 'IC': 'CFFEX', 'IH': 'CFFEX'
}
```

## å¢é‡æ›´æ–°æœºåˆ¶

### æ–‡ä»¶çº§åˆ«å¢é‡
- è®°å½•å·²å¤„ç†è¿‡çš„.lc1æ–‡ä»¶è·¯å¾„
- åªå¤„ç†æ–°å¢çš„æ–‡ä»¶
- é¿å…é‡å¤è½¬æ¢å’Œå¯¼å…¥

### æ•°æ®çº§åˆ«å¢é‡
- è·Ÿè¸ªæ¯ä¸ªåˆçº¦çš„æœ€åæ›´æ–°æ—¶é—´
- åªèšåˆæ–°å¢çš„1åˆ†é’Ÿæ•°æ®
- æ”¯æŒå°æ—¶çº¿å’Œæ—¥çº¿çš„å¢é‡ç”Ÿæˆ

### æ—¶é—´é˜ˆå€¼
- é»˜è®¤24å°æ—¶æ£€æŸ¥ä¸€æ¬¡æ›´æ–°
- å¯é€šè¿‡å‚æ•°è°ƒæ•´æ£€æŸ¥é¢‘ç‡
- æ”¯æŒå¼ºåˆ¶å…¨é‡æ›´æ–°

## ç›‘æ§å’Œæ—¥å¿—

### çŠ¶æ€ç›‘æ§
```python
# æŸ¥çœ‹å½“å‰å¤„ç†çŠ¶æ€
status = pipeline.check_status()

# æŸ¥çœ‹æ›´æ–°æ£€æŸ¥ç»“æœ
updates = pipeline.check_updates()
```

### æ—¥å¿—è¾“å‡º
- è¯¦ç»†çš„å¤„ç†è¿›åº¦ä¿¡æ¯
- é”™è¯¯ä¿¡æ¯å’Œè­¦å‘Š
- å¤„ç†ç»Ÿè®¡ä¿¡æ¯

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ‰¾ä¸åˆ°æ•°æ®åº“æ–‡ä»¶**
   - ç¡®ä¿vnpyå·²æ­£ç¡®å®‰è£…å’Œé…ç½®
   - æ£€æŸ¥ `~/.vntrader/database.db` æ–‡ä»¶æ˜¯å¦å­˜åœ¨

2. **æ–‡ä»¶ç¼–ç é—®é¢˜**
   - ç¡®ä¿.lc1æ–‡ä»¶ä½¿ç”¨æ­£ç¡®çš„ç¼–ç 
   - æ£€æŸ¥CSVæ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®

3. **æƒé™é—®é¢˜**
   - ç¡®ä¿ç¨‹åºæœ‰è¯»å†™ç›¸å…³ç›®å½•çš„æƒé™
   - æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶æƒé™

4. **å†…å­˜ä¸è¶³**
   - å¯¹äºå¤§å‹æ•°æ®é›†ï¼Œè€ƒè™‘åˆ†æ‰¹å¤„ç†
   - å¢åŠ ç³»ç»Ÿå†…å­˜æˆ–ä½¿ç”¨æ›´é«˜æ•ˆçš„é…ç½®

### æ¢å¤æœºåˆ¶

- **æ–­ç‚¹ç»­ä¼ **ï¼šç³»ç»Ÿä¼šè®°å½•å¤„ç†çŠ¶æ€ï¼Œä¸­æ–­åå¯ç»§ç»­å¤„ç†
- **é”™è¯¯é‡è¯•**ï¼šå•ä¸ªåˆçº¦å¤„ç†å¤±è´¥ä¸å½±å“å…¶ä»–åˆçº¦
- **å›æ»šæ”¯æŒ**ï¼šæ”¯æŒåˆ é™¤é”™è¯¯æ•°æ®é‡æ–°å¤„ç†

## æ€§èƒ½ä¼˜åŒ–

### æ•°æ®èšåˆä¼˜åŒ–
- ä½¿ç”¨pandasçš„å‘é‡åŒ–æ“ä½œæ›¿ä»£å¾ªç¯
- æ”¯æŒå¢é‡èšåˆå‡å°‘è®¡ç®—é‡
- æ™ºèƒ½çš„å†…å­˜ç®¡ç†å’Œæ‰¹é‡å¤„ç†

### æŸ¥è¯¢ä¼˜åŒ–
- æ•°æ®åº“æŸ¥è¯¢ä½¿ç”¨ç´¢å¼•
- é¿å…å…¨è¡¨æ‰«æ
- æ”¯æŒæ—¶é—´èŒƒå›´è¿‡æ»¤

### å¹¶è¡Œå¤„ç†
- åˆçº¦çº§åˆ«å¹¶è¡Œå¤„ç†
- æ‰¹é‡æ•°æ®åº“æ“ä½œ
- å¼‚æ­¥æ–‡ä»¶I/O

## æ‰©å±•å¼€å‘

### æ·»åŠ æ–°çš„æ•°æ®æº
ç»§æ‰¿ `ManagerEngine` ç±»ï¼Œé‡å†™ç›¸å…³æ–¹æ³•ï¼š
```python
class CustomDataManager(ManagerEngine):
    def custom_import_method(self):
        # å®ç°è‡ªå®šä¹‰æ•°æ®å¯¼å…¥é€»è¾‘
        pass
```

### è‡ªå®šä¹‰èšåˆé€»è¾‘
æ‰©å±• `BarDataPreprocessor` ç±»ï¼š
```python
class CustomPreprocessor(BarDataPreprocessor):
    def custom_aggregation(self):
        # å®ç°è‡ªå®šä¹‰èšåˆé€»è¾‘
        pass
```

## æ›´æ–°æ—¥å¿—

### v2.0.0
- âœ¨ é‡æ„ä¸ºç»Ÿä¸€æ•°æ®æµæ°´çº¿
- âœ¨ æ·»åŠ å¢é‡æ›´æ–°æ”¯æŒ
- âœ¨ å®ç°æ™ºèƒ½çŠ¶æ€ç®¡ç†
- ğŸ”§ ä¼˜åŒ–æ€§èƒ½å’Œå†…å­˜ä½¿ç”¨
- ğŸ“ å®Œå–„æ–‡æ¡£å’Œé”™è¯¯å¤„ç†
