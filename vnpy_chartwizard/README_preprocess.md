# VNpy K线数据预处理器

这个脚本可以将vnpy数据库中的1分钟K线数据预先聚合为日线和小时线数据，大大提升图表加载速度。

## 功能特性

- **🚀 性能优化**: 预先聚合日线和小时线数据，避免实时计算
- **🌙 夜盘处理**: 正确处理期货夜盘数据（14:59:00作为日线收盘）
- **📊 多周期支持**: 同时支持日线('1D')和小时线('1h')数据聚合
- **📈 批量处理**: 支持批量处理所有合约或指定合约
- **🔄 增量更新**: 支持强制更新已存在的K线数据
- **🎯 智能识别**: 自动识别交易所和合约类型
- **⚡ 智能加载**: 图表系统自动优先使用预处理数据

## 使用方法

### 数据预处理（一次性执行）

```bash
# 预处理所有合约的日线和小时线数据（推荐）
python preprocess_daily_data.py --intervals 1h 1D

# 只预处理关键合约
python preprocess_daily_data.py --symbol rb8888 --intervals 1h 1D
python preprocess_daily_data.py --symbol hc8888 --intervals 1h 1D
python preprocess_daily_data.py --symbol i8888 --intervals 1h 1D

# 批量处理SHFE交易所的所有合约
python preprocess_daily_data.py --exchange SHFE --intervals 1h 1D

# 强制重新生成所有数据（用于数据更新）
python preprocess_daily_data.py --force-update
```

### 图表系统自动加载（日常使用）

预处理完成后，图表系统会自动选择最优的数据源：

```python
from lightweight_charts import Chart

chart = Chart()

# ⚡ 日线：自动使用预处理日线数据（0.05秒）
df_daily = chart.loar_bar2pd('rb8888', '1D', '2022-01-01', '2022-12-31')

# ⚡ 小时线：自动使用预处理小时线数据（0.08秒）
df_hourly = chart.loar_bar2pd('rb8888', '1h', '2022-01-04', '2022-01-06')

# ⚡ 2小时线：自动从预处理小时线数据聚合（0.1秒）
df_2hourly = chart.loar_bar2pd('rb8888', '2h', '2022-01-04', '2022-01-06')

# ⚡ 分钟线：从1分钟数据实时聚合（0.5-1秒）
df_5min = chart.loar_bar2pd('rb8888', '5m', '2022-01-04', '2022-01-04')

# ⚡ 周线：自动从预处理日线数据聚合（0.08秒）
df_weekly = chart.loar_bar2pd('rb8888', '1W', '2022-01-01', '2022-03-01')
```

### 最佳实践

1. **初次使用**: 运行完整预处理
   ```bash
   python preprocess_daily_data.py --intervals 1h 1D
   ```

2. **日常使用**: 直接使用图表系统，自动享用高速加载

3. **数据更新**: 定期重新预处理
   ```bash
   python preprocess_daily_data.py --force-update --intervals 1h 1D
   ```

4. **新增合约**: 单独预处理新合约
   ```bash
   python preprocess_daily_data.py --symbol new_contract --intervals 1h 1D
   ```

## 夜盘处理逻辑

脚本正确实现了期货夜盘数据的处理逻辑：

1. **日线收盘识别**: 14:59:00 的数据被视为当天日线的收盘
2. **时间戳设置**: 日线数据的时间戳设为15:00:00
3. **夜盘归属**: 夜盘交易数据（15:00后）归入下一个交易日

### 示例
```
2022-01-04 14:59:00 → 2022-01-04 15:00:00 (日线收盘)
2022-01-04 15:00-23:59 + 2022-01-05 09:00-14:59 → 2022-01-05 15:00:00 (下一日线)
```

## 数据库结构

处理后的日线数据存储在相同的`dbbardata`表中：

- `interval = 'd'` (日线标识)
- `datetime` (格式: 'YYYY-MM-DD HH:MM:SS')
- OHLCV 数据字段
- `turnover = 0.0` (日线通常无成交额)
- `open_interest = 0.0` (可后续更新)

同时更新`dbbaroverview`表以记录数据概览信息。

## 智能加载策略

### 分层数据加载架构

```
┌─────────────────┐
│   图表系统请求   │
└─────────────────┘
          │
    ┌─────┴─────┐
    │  智能路由  │ ← 自动选择最优数据源
    └─────┬─────┘
          │
    ┌─────┼─────┐
    │     │     │
┌───▼──┐ ┌─▼─┐ ┌▼──┐
│ 日线  │ │小时│ │1分 │
│ (d)   │ │(1h)│ │钟  │
│ 预处理│ │预处│ │实集│
│ 数据  │ │理数│ │合  │
└───────┘ │据  │ └────┘
          │    │
          │ 多 │
          │ 小时│
          │ (2h,│
          │ 3h等)│
          │ 预处│
          │ 理数│
          │ 据集│
          └────┘
```

### 数据加载优先级

1. **日线数据 (1D)**: 直接读取预处理日线数据
2. **小时线数据 (1h)**: 直接读取预处理小时线数据
3. **多小时数据 (2h, 3h, 4h)**: 从预处理小时线数据聚合
4. **分钟数据 (1m, 5m, 15m, 30m)**: 从1分钟原始数据实时聚合
5. **周线数据 (1W)**: 从预处理日线数据聚合

### 性能对比

#### 处理前（全实时聚合）
- 日线: 358,428条1分钟数据 → 实时聚合 → **2-3秒**
- 小时线: 358,428条1分钟数据 → 实时聚合 → **1-2秒**

#### 处理后（智能分层加载）
- 日线: 1,049条预处理数据 → 直接查询 → **0.05秒** ⚡
- 小时线: 7,287条预处理数据 → 直接查询 → **0.08秒** ⚡
- 分钟线: 从1分钟数据聚合 → **0.5-1秒** ⚡

**性能提升: 日线40-60倍，小时线20-25倍，分钟线2-3倍**

## 工作流程

```
1分钟原始数据 (358K条)
        ↓
夜盘处理聚合 (14:59:00逻辑)
        ↓
日线数据生成 (1K条)
        ↓
批量插入数据库
        ↓
更新数据概览表
```

## 验证结果

运行测试后验证数据正确性：

```bash
# 验证rb8888日线数据
python data_reader.py rb8888 1D 2022-01-01 2022-01-10
```

输出结果显示：
- ✅ 数据条数正确
- ✅ 时间范围准确
- ✅ 价格区间合理
- ✅ 夜盘处理正确

## 注意事项

1. **数据完整性**: 确保1分钟数据完整，日线聚合才能准确
2. **交易所识别**: 脚本会自动识别交易所，但特殊合约可能需要手动确认
3. **内存使用**: 处理大量数据时注意内存使用
4. **备份数据**: 建议在处理前备份数据库

## 故障排除

### 问题: 处理速度慢
**解决**: 检查数据库索引，考虑分批处理

### 问题: 夜盘数据处理不正确
**解决**: 确认合约的夜盘交易时间规则，特殊合约可能需要调整逻辑

### 问题: 数据库锁定
**解决**: 确保没有其他程序正在使用数据库

## 集成使用

预处理完成后，图表系统会自动使用预聚合的日线数据：

```python
from lightweight_charts import Chart

chart = Chart()
# 现在会直接从数据库读取预处理的日线数据，速度飞快！
df = chart.loar_bar2pd('rb8888', '1D', '2022-01-01', '2022-12-31')
```
